# 校验，数据绑定和类型转换

## 介绍

Spring4.0是支持Bean Validation1.0和1.1的，Spring认为将数据校验作为业务逻辑有利有弊，  良好的验证方案不应绑定到Web层并可以本地化，而且可以插入任务可用的校验器。Spring提供了[`Validator`](https://docs.spring.io/spring/docs/4.3.19.RELEASE/javadoc-api/org/springframework/validation/Validator.html)接口在所有层都可以使用。
数据绑定是将用户的输入动态的绑定到领域模型或者是其他的对象，Spring提供了[`DataBinder`](https://docs.spring.io/spring/docs/4.3.19.RELEASE/javadoc-api/org/springframework/validation/DataBinder.html)接口在完成整个任务，`Validator`和DataBinder是[`org.springframework.validation`](https://docs.spring.io/spring/docs/4.3.19.RELEASE/javadoc-api/org/springframework/validation/package-summary.html)包下

[`BeanWrapper`](https://docs.spring.io/spring/docs/4.3.19.RELEASE/javadoc-api/org/springframework/beans/BeanWrapper.html)基本的概念并且在Spring中使用到的地方非常多,但是你不会直接使用到它，通常使用数据绑定就会用到它

[`PropertyEditor`](https://docs.oracle.com/javase/7/docs/api/java/beans/PropertyEditor.html)是DataBinder和BeanWrapper用来解析和格式化属性值的，它是JavaBeans规范，Spring3引入了[`core.convert`](https://docs.spring.io/spring/docs/4.3.19.RELEASE/javadoc-api/org/springframework/core/convert/package-summary.html)包用于一般的类型转化，[`format`](https://docs.spring.io/spring/docs/4.3.19.RELEASE/javadoc-api/org/springframework/format/package-summary.html)包用户格式化UI上的值，这些新的包作为ProertyEditors的简单提单

## 校验使用Spring的Validator接口

Spring使用`Validator`接口来校验对象，它使用`Errors`对象报告校验的失败信息.Validator接口提供了两个方法

```java
boolean supports(Class<?> clazz);
void validate(Object target, Errors errors);
```

`supports`方法判断实现类是否可以校验`clazz`类型实例
`validate`方法校验target对象，将错误信息写入`errors`对象

一个简单的Validator实现例子

```java
public class PersonValidator implements Validator {

    @Override
    public boolean supports(Class<?> clazz) {
        return Person.class.equals(clazz);
    }

    @Override
    public void validate(Object target, Errors errors) {
        ValidationUtils.rejectIfEmpty(errors, "name", "name.empty");
        Person s = (Person)target;
        if(s.getAge()<0){
            errors.rejectValue("age", "negativevalue");
        }else if(s.getAge() > 110) {
            errors.rejectValue("age", "too.man.old");
        }
    }
}
```

`ValidationUtils`是一个工具类，封装了判空和调用Validator实现的工具方法。校验器中除了最常用的方法就是它
嵌套Bean校验最好为每个对象使用各自的校验器，比如Customer是一个嵌套的JavaBean，本身成员变量由3个，其中由两个是字符串型，用于描述姓和名字，一个Address描述住址，那么要校验Customer的需要由两个校验器:CustomerValidator和AddressValidator,分别校验各自的对象

```java
public class CustomerValidator implements Validator {
    private final Validator addressValidator;//像Customer的嵌套Address，它的校验也是嵌套的

    public CustomerValidator(Validator addressValidator) {
        if(addressValidator==null) {
            throw new IllegalArgumentException("addressValidator is null");
        }
        if(addressValidator.supports(Address.class)) {
            throw new IllegalArgumentException("Validator is not addressValidator ");
        }
        this.addressValidator = addressValidator;
    }

    @Override
    public boolean supports(Class<?> clazz) {
        return Customer.class.equals(clazz);
    }

    @Override
    public void validate(Object target, Errors errors) {
        ValidationUtils.rejectIfEmptyOrWhitespace(errors, "firstName", "firstName.empty");
        ValidationUtils.rejectIfEmptyOrWhitespace(errors, "givenNme", "givenNme.empty");

        Customer cust = (Customer)target;

        try{
            errors.pushNestedPath("address");
            ValidationUtils.invokeValidator(addressValidator, cust.getAddress(), errors);
        }finally{
            errors.popNestedPath();
        }

    }
}
```

## 解决错误代码映射错误消息

## Bean维护和Bean包装

## Spring类型转换

## Spring字段格式化

## 配置全局的日期和时间格式

## Spring的校验框架